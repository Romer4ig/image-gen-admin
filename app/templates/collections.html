{% extends "base.html" %}

{% block title %}Коллекции{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Коллекции</h1>
    <div class="dropdown batch-actions" style="display: none;">
        <button class="btn btn-primary dropdown-toggle" type="button" id="batchActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Действия с выбранными (<span id="selectedCount">0</span>)
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="batchActionsDropdown">
            <li>
                <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#batchGenerateModal">
                    <i class="bi bi-images"></i> Сгенерировать для проекта...
                </a>
            </li>
        </ul>
    </div>
</div>

{% if collections or total_count > 0 %}
<div class="mb-3">
    <div class="row g-3 align-items-center">
        <div class="col-md-8">
            <form method="get" action="{{ url_for('main.collections') }}" class="d-flex align-items-center">
                <span class="me-2">Фильтр по типу:</span>
                <select name="type" class="form-select me-2" onchange="this.form.submit()">
                    <option value="">Все типы</option>
                    {% for type in types %}
                    <option value="{{ type }}" {% if current_type == type %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
                
                <span class="me-2 ms-3">Проект:</span>
                <select name="project" class="form-select me-2" onchange="this.form.submit()">
                    <option value="">Все проекты</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if current_project|string == project.id|string %}selected{% endif %}>{{ project.title }}</option>
                    {% endfor %}
                </select>
                
                {% if current_type or current_project %}
                <a href="{{ url_for('main.collections') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-circle"></i> Сбросить
                </a>
                {% endif %}
            </form>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex align-items-center justify-content-end">
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="enableBatchMode">
                    <label class="form-check-label" for="enableBatchMode">Режим выбора</label>
                </div>
                <span class="badge bg-info">Показано: {{ collections|length }} из {{ total_count }}</span>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <div class="d-flex align-items-center">
        <span class="me-2">Легенда статусов:</span>
        <span class="badge bg-primary me-2">Без генерации</span>
        <span class="badge bg-warning me-2">В процессе</span>
        <span class="badge bg-success me-2">Сгенерировано</span>
        <span class="badge bg-danger me-2">Ошибка</span>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover" id="collectionsTable">
        <thead class="table-primary">
            <tr>
                <th scope="col" class="batch-checkbox-col" style="width: 40px; display: none;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCollections">
                    </div>
                </th>
                <th scope="col" style="width: 5%">ID</th>
                <th scope="col" style="width: 25%">Название</th>
                <th scope="col" style="width: 10%">Тип</th>
                <th scope="col" style="width: 15%">Проекты</th>
                <th scope="col" style="width: 35%">Промпт</th>
                <th scope="col" style="width: 10%">Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for collection in collections %}
            <tr>
                <td class="batch-checkbox-col" style="display: none;">
                    <div class="form-check">
                        <input class="form-check-input collection-checkbox" type="checkbox" value="{{ collection.id }}" data-title="{{ collection.title }}">
                    </div>
                </td>
                <td>{{ collection.id }}</td>
                <td>{{ collection.title }}</td>
                <td>
                    <a href="{{ url_for('main.collections', type=collection.type) }}" class="badge bg-secondary text-decoration-none">
                        {{ collection.type }}
                    </a>
                </td>
                <td>
                    {% for project in collection_projects.get(collection.id, []) %}
                    {% set key = collection.id ~ '-' ~ project.id %}
                    {% set status = generation_status.get(key) %}
                    <div class="project-badge-wrapper d-inline-block me-1 mb-1">
                        {% if status == 'completed' %}
                        <a href="{{ url_for('main.collections', project=project.id) }}" class="badge bg-success project-badge text-decoration-none" 
                           data-collection-id="{{ collection.id }}" data-project-id="{{ project.id }}" 
                           data-bs-toggle="tooltip" title="Изображение сгенерировано! Нажмите для фильтрации. Щелкните правой кнопкой для меню.">
                            {{ project.title }}
                        </a>
                        {% elif status == 'pending' %}
                        <a href="{{ url_for('main.collections', project=project.id) }}" class="badge bg-warning project-badge text-decoration-none" 
                           data-collection-id="{{ collection.id }}" data-project-id="{{ project.id }}" 
                           data-bs-toggle="tooltip" title="Генерация в процессе... Нажмите для фильтрации. Щелкните правой кнопкой для меню.">
                            {{ project.title }}
                        </a>
                        {% elif status == 'failed' %}
                        <a href="{{ url_for('main.collections', project=project.id) }}" class="badge bg-danger project-badge text-decoration-none" 
                           data-collection-id="{{ collection.id }}" data-project-id="{{ project.id }}" 
                           data-bs-toggle="tooltip" title="Ошибка генерации! Нажмите для фильтрации. Щелкните правой кнопкой для меню.">
                            {{ project.title }}
                        </a>
                        {% else %}
                        <a href="{{ url_for('main.collections', project=project.id) }}" class="badge bg-primary project-badge text-decoration-none" 
                           data-collection-id="{{ collection.id }}" data-project-id="{{ project.id }}" 
                           data-bs-toggle="tooltip" title="Нажмите для фильтрации. Щелкните правой кнопкой для генерации.">
                            {{ project.title }}
                        </a>
                        {% endif %}
                        <div class="project-badge-menu" style="display: none;">
                            <form action="{{ url_for('main.generate_image', collection_id=collection.id, project_id=project.id) }}?redirect_to=collection" method="post">
                                <button type="submit" class="badge bg-success border-0 w-100 mb-1" 
                                        data-bs-toggle="tooltip" title="Создать задачу на генерацию изображения">
                                    <i class="bi bi-image"></i> Сгенерировать
                                </button>
                            </form>
                            <form action="{{ url_for('main.generate_image', collection_id=collection.id, project_id=project.id) }}?redirect_to=collection" method="post" class="mb-1">
                                <input type="hidden" name="force_generation" value="1">
                                <button type="submit" class="badge bg-warning border-0 w-100" 
                                        data-bs-toggle="tooltip" title="Принудительно создать новую задачу">
                                    <i class="bi bi-lightning"></i> Принудительно
                                </button>
                            </form>
                            <a href="{{ url_for('main.tasks', collection_id=collection.id, project_id=project.id) }}" 
                               class="badge bg-info border-0 w-100 d-block mb-1 text-decoration-none">
                                <i class="bi bi-list-check"></i> Задачи
                            </a>
                            {% if status == 'completed' %}
                            <a href="{{ url_for('main.tasks', collection_id=collection.id, project_id=project.id, status='completed') }}" 
                               class="badge bg-success border-0 w-100 d-block mb-1 text-decoration-none">
                                <i class="bi bi-eye"></i> Результат
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </td>
                <td>
                    <div title="{{ collection.prompt }}" style="width: 100%;">
                        <textarea style="width: 100%;">{{ collection.prompt }}</textarea>
                    </div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <form action="{{ url_for('main.batch_generate') }}" method="post" class="d-inline">
                            <input type="hidden" name="collection_ids" value="{{ collection.id }}">
                            <button type="button" class="btn btn-outline-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#generateModal{{ collection.id }}" 
                                    title="Сгенерировать для проекта">
                                <i class="bi bi-image"></i>
                            </button>
                            
                            <!-- Модальное окно для выбора проекта -->
                            <div class="modal fade" id="generateModal{{ collection.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Выберите проект для генерации</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label for="projectSelect{{ collection.id }}">Проект:</label>
                                                <select class="form-select" id="projectSelect{{ collection.id }}" name="project_id" required>
                                                    <option value="">-- Выберите проект --</option>
                                                    {% for project in projects %}
                                                    <option value="{{ project.id }}">{{ project.title }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div class="form-check mt-3">
                                                <input class="form-check-input" type="checkbox" id="forceGeneration{{ collection.id }}" name="force_generation" value="1">
                                                <label class="form-check-label" for="forceGeneration{{ collection.id }}">
                                                    Принудительная генерация
                                                </label>
                                                <div class="form-text">
                                                    Генерировать задачу даже если уже существует активная
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                            <button type="submit" class="btn btn-primary">Сгенерировать</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if collections|length == 0 and (current_type or current_project) %}
<div class="alert alert-warning mb-3">
    Нет коллекций с выбранными фильтрами. <a href="{{ url_for('main.collections') }}">Показать все коллекции</a>
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
    Нет доступных коллекций.
</div>
{% endif %}

<!-- Модальное окно для пакетной генерации -->
<div class="modal fade" id="batchGenerateModal" tabindex="-1" aria-labelledby="batchGenerateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchGenerateModalLabel">Пакетная генерация изображений</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.batch_generate') }}" method="post" id="batchGenerateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Выбранные коллекции:</h6>
                        <div id="selectedCollectionsList" class="list-group">
                            <!-- Список выбранных коллекций будет добавлен динамически -->
                        </div>
                        <div id="noCollectionsMessage" class="alert alert-warning mt-2" style="display: none;">
                            Не выбрано ни одной коллекции.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="projectSelect" class="form-label">Выберите проект для генерации:</label>
                        <select class="form-select" id="projectSelect" name="project_id" required>
                            <option value="">-- Выберите проект --</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-basic-prompt="{{ project.basic_prompt }}">{{ project.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceGeneration" name="force_generation" value="1">
                            <label class="form-check-label" for="forceGeneration">
                                Принудительная генерация
                            </label>
                            <div class="form-text">
                                Если включено, будут созданы задачи для всех выбранных коллекций, даже если для них уже существуют активные задачи.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-text">
                            <strong>Примечание:</strong> Будет создана отдельная задача для каждой выбранной коллекции с выбранным проектом.
                            {% if not force_generation %}Если для какой-то пары коллекция-проект уже есть активная задача, новая задача не будет создана.{% endif %}
                        </div>
                    </div>
                    
                    <!-- Скрытые input для передачи выбранных коллекций -->
                    <div id="hiddenCollectionInputs">
                        <!-- Здесь будут созданы hidden inputs динамически -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="startBatchGeneration">Запустить генерацию</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.project-badge-wrapper {
    position: relative;
}

.project-badge-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    padding: 0.5rem;
    min-width: 150px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.selected-collection-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-actions {
    transition: opacity 0.3s;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация тултипов
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Обработка клика правой кнопкой на бейдже проекта
    const projectBadges = document.querySelectorAll('.project-badge');
    projectBadges.forEach(badge => {
        badge.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            
            // Закрываем все открытые меню
            document.querySelectorAll('.project-badge-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Показываем меню у текущего бейджа
            const menu = this.closest('.project-badge-wrapper').querySelector('.project-badge-menu');
            menu.style.display = 'block';
        });
    });
    
    // Закрываем меню при клике в любом месте страницы
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.project-badge-wrapper')) {
            document.querySelectorAll('.project-badge-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });
    
    // Режим пакетного выбора коллекций
    const enableBatchModeCheckbox = document.getElementById('enableBatchMode');
    const batchCheckboxCols = document.querySelectorAll('.batch-checkbox-col');
    const batchActions = document.querySelector('.batch-actions');
    const collectionCheckboxes = document.querySelectorAll('.collection-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCollections');
    const selectedCountElement = document.getElementById('selectedCount');
    
    // Функция для обновления счетчика выбранных элементов
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.collection-checkbox:checked').length;
        selectedCountElement.textContent = selectedCount;
        
        if (selectedCount > 0) {
            batchActions.style.display = 'block';
        } else {
            batchActions.style.display = 'none';
        }
    }
    
    // Обработчик включения/выключения режима выбора
    enableBatchModeCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        
        batchCheckboxCols.forEach(col => {
            col.style.display = isChecked ? 'table-cell' : 'none';
        });
        
        if (!isChecked) {
            // Снимаем все выделения при выключении режима
            collectionCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllCheckbox.checked = false;
            updateSelectedCount();
        }
    });
    
    // Обработчик выбора всех коллекций
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        
        collectionCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        updateSelectedCount();
    });
    
    // Обработчик выбора отдельных коллекций
    collectionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            
            // Проверяем, все ли чекбоксы выбраны
            const allChecked = document.querySelectorAll('.collection-checkbox:not(:checked)').length === 0;
            selectAllCheckbox.checked = allChecked;
        });
    });
    
    // Модальное окно для пакетной генерации
    const batchGenerateModal = document.getElementById('batchGenerateModal');
    const selectedCollectionsList = document.getElementById('selectedCollectionsList');
    const hiddenCollectionInputs = document.getElementById('hiddenCollectionInputs');
    const noCollectionsMessage = document.getElementById('noCollectionsMessage');
    const startBatchGenerationButton = document.getElementById('startBatchGeneration');
    
    // Обработчик открытия модального окна
    batchGenerateModal.addEventListener('show.bs.modal', function() {
        // Очищаем списки
        selectedCollectionsList.innerHTML = '';
        hiddenCollectionInputs.innerHTML = '';
        
        // Получаем выбранные коллекции
        const selectedCheckboxes = document.querySelectorAll('.collection-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            noCollectionsMessage.style.display = 'block';
            startBatchGenerationButton.disabled = true;
        } else {
            noCollectionsMessage.style.display = 'none';
            startBatchGenerationButton.disabled = false;
            
            // Добавляем выбранные коллекции в список и создаем скрытые поля
            selectedCheckboxes.forEach(checkbox => {
                const collectionId = checkbox.value;
                const collectionTitle = checkbox.dataset.title;
                
                // Добавляем в визуальный список
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item selected-collection-item';
                listItem.innerHTML = `
                    <span>${collectionTitle}</span>
                    <small class="text-muted">ID: ${collectionId}</small>
                `;
                selectedCollectionsList.appendChild(listItem);
                
                // Создаем скрытое поле для формы
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'collection_ids';
                hiddenInput.value = collectionId;
                hiddenCollectionInputs.appendChild(hiddenInput);
            });
        }
    });
    
    // Обработчик изменения выбранного проекта
    const projectSelect = document.getElementById('projectSelect');
    projectSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const basicPrompt = selectedOption.dataset.basicPrompt || '';
        
        // Здесь можно добавить логику для отображения базового промпта, если нужно
    });
});
</script>
{% endblock %} 